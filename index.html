<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ResiKu ‚Äî Cetak Resi (LocalStorage, FINAL)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0d10;--panel:#0f1318;--muted:#8b9bb3;--text:#e9eef7;--brand:#7c5cff;--brand2:#00e0a4;--border:rgba(255,255,255,.08);--danger:#ff6b6b;--ok:#29d17e;--shadow:0 12px 36px rgba(0,0,0,.35)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:
radial-gradient(900px 550px at 110% 10%, rgba(0,224,164,.12), transparent 50%),var(--bg);line-height:1.5}
.topbar{position:sticky;top:0;z-index:20;display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border)}
.brand{font-weight:800}.brand .dot{color:var(--brand)}
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tab{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--brand),var(--brand2));border:none;color:#fff;font-weight:800}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px}
.badge.ok{border-color:rgba(41,209,126,.5);background:rgba(41,209,126,.08);color:#c9ffe6}
.badge.err{border-color:rgba(255,107,107,.5);background:rgba(255,107,107,.08);color:#ffd6d6}
.container{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
.grid{display:grid;gap:16px;grid-template-columns:1.1fr .9fr}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:700px){.row{grid-template-columns:1fr}}
label{display:grid;gap:6px;font-size:14px;margin-bottom:10px}
input,textarea,select{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
input[type=file]{padding:8px}
textarea{min-height:88px;resize:vertical}
button{border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.04));color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s}
button:hover{transform:translateY(-1px)}button:active{transform:translateY(0) scale(.98)}
.btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border:none;color:#fff;font-weight:800}
.btn-ghost{background:transparent;border-color:var(--border)}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.small{font-size:12px;color:var(--muted)}
.preview-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.preview-info{color:var(--muted);font-size:13px}
.preview-box{display:grid;place-items:center;padding:8px}
#previewCanvas{width:300px;height:450px;border-radius:12px;background:#fff;border:1px solid #ddd;box-shadow:0 10px 24px rgba(0,0,0,.35);cursor:zoom-in}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.center{text-align:center}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left}
.table th{color:var(--muted);font-weight:600}
.hidden{display:none !important}
@media print{body>*:not(#printOnly){display:none !important}}
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Resi<span class="dot">Ku</span> ‚Äî Local</div>
    <div class="nav">
      <button class="tab active" id="tabMake" type="button">Buat Label</button>
      <button class="tab" id="tabHistory" type="button">Riwayat</button>
      <span id="lsStatus" class="badge">Memeriksa storage‚Ä¶</span>
      <span style="flex:1"></span>
      <a href="admin.html" class="btn-ghost">üîê Admin</a>
      <button id="saveLocalBtn" class="btn-ghost" type="button">üíæ Simpan</button>
      <button id="printBtn" class="btn-ghost" type="button">üñ® Cetak</button>
      <button id="dlPngBtn" class="btn-ghost" type="button">‚¨áÔ∏è PNG</button>
      <button id="resetBtn" class="btn-danger" type="button">‚Ü∫ Reset Riwayat</button>
    </div>
  </header>

  <div class="container">
    <!-- ================== PAGE: MAKE ================== -->
    <div id="pageMake">
      <div class="grid">
        <!-- FORM -->
        <section class="card">
          <h2 style="margin:.2em 0">Data Pengiriman</h2>

          <h3 style="margin:12px 0 6px">Brand</h3>
          <div class="row">
            <label>Nama Store / ResiKu
              <input id="brandName" placeholder="Contoh: Ham Store">
            </label>
            <label>Logo (opsional)
              <input id="brandLogo" type="file" accept="image/*">
            </label>
          </div>

          <!-- (kolom QR Tracking DIHAPUS, hanya QR resi yang dicetak) -->

          <h3 style="margin:12px 0 6px">Pengirim</h3>
          <div class="row">
            <label>Nama Pengirim
              <input id="senderName" placeholder="Nama Toko / Nama Anda">
            </label>
            <label>No. Telp Pengirim
              <input id="senderPhone" placeholder="08xxxxxxxxxx">
            </label>
          </div>
          <label>Alamat Pengirim
            <textarea id="senderAddress" placeholder="Jalan, No, RT/RW, Kel/Desa, Kec, Kota, Provinsi, Kode Pos"></textarea>
          </label>

          <h3 style="margin:16px 0 6px">Penerima</h3>
          <div class="row">
            <label>Nama Penerima
              <input id="buyerName" placeholder="Contoh: Andi Saputra">
            </label>
            <label>No. WhatsApp Penerima
              <input id="buyerPhone" placeholder="08xxxxxxxxxx">
            </label>
          </div>
          <label>Alamat Penerima
            <textarea id="buyerAddress" placeholder="Jalan, No, RT/RW, Kel/Desa, Kec, Kota, Provinsi, Kode Pos"></textarea>
          </label>

          <div class="row">
            <label>Kurir
              <select id="courier">
                <option>JNE</option><option>J&amp;T</option><option>SiCepat</option>
                <option>POS Indonesia</option><option>AnterAja</option><option>Wahana</option>
              </select>
            </label>
            <label>Layanan
              <select id="service">
                <option>REG</option><option>YES</option><option>ECO</option><option>COD</option>
              </select>
            </label>
          </div>

          <div class="row">
            <label>Jumlah Item
              <input id="items" type="number" min="1" value="1">
            </label>
            <label>Berat (gram)
              <input id="weight" type="number" min="1" value="500">
            </label>
          </div>

          <label>Catatan (opsional)
            <input id="note" placeholder="Patokan, jam kirim, dll.">
          </label>

          <div class="row">
            <label>Ukuran Kertas Saat Cetak (PC)
              <select id="paper">
                <option value="10x15" selected>Thermal 10√ó15 cm</option>
                <option value="a6">A6 (10.5√ó14.8 cm)</option>
              </select>
            </label>
            <label>Nomor Resi (otomatis bila kosong)
              <input id="resi" placeholder="Biarkan kosong untuk auto">
            </label>
          </div>

          <div class="actions" style="justify-content:flex-end">
            <button id="previewBtn" class="btn-primary" type="button">Perbarui Preview</button>
          </div>
          <p class="small center">Perbarui Preview ‚Üí klik gambar ‚Üí Cetak / Download / Simpan.</p>
        </section>

        <!-- PREVIEW -->
        <section class="card">
          <div class="preview-head">
            <h2 style="margin:0">Preview Label</h2>
            <div class="actions">
              <button id="quickResiBtn" class="btn-ghost" type="button">‚ö° Auto Resi</button>
              <button id="printBtn2" type="button">üñ® Cetak</button>
              <button id="dlPngBtn2" class="btn-ghost" type="button">‚¨áÔ∏è PNG</button>
              <button id="saveLocalBtn2" class="btn-ghost" type="button">üíæ Simpan</button>
            </div>
          </div>
          <div class="preview-info">Klik gambar di bawah untuk cetak cepat.</div>
          <div class="preview-box">
            <canvas id="previewCanvas" width="1000" height="1500" title="Ketuk untuk Cetak"></canvas>
          </div>
        </section>
      </div>

      <div class="card center small">
        PC: pilih kertas <b>100√ó150 mm</b> atau <b>A6</b> saat print. HP: paling stabil **Download PNG** lalu cetak dari Galeri/Printer app.
      </div>
    </div>

    <!-- ================== PAGE: HISTORY ================== -->
    <div id="pageHistory" class="hidden">
      <section class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
          <input id="histSearch" placeholder="Cari resi / brand..." style="flex:1 1 240px">
          <button id="histRefresh" class="btn-ghost" type="button">üîÑ Refresh</button>
          <button id="exportJson" class="btn-ghost" type="button">‚¨áÔ∏è Export JSON</button>
          <label class="btn-ghost" style="cursor:pointer">‚¨ÜÔ∏è Import JSON
            <input id="importJson" type="file" accept="application/json" style="display:none">
          </label>
        </div>
        <div class="table-wrap">
          <table class="table" id="histTable">
            <thead>
              <tr><th>Tanggal</th><th>Resi</th><th>Brand</th><th>Kurir</th><th>Layanan</th><th>Aksi</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="small">Riwayat tersimpan di <code>localStorage.labels</code> (hilang jika cache dibersihkan).</p>
      </section>
    </div>
  </div>

<div id="printOnly"></div>

<!-- qrcode.js mini (untuk QR RESI) -->
<script>
/*! qrcode.js v1.0.0 (MIT) | https://github.com/davidshimjs/qrcodejs */
!function(o){function r(o){this.mode=t.MODE_8BIT_BYTE,this.data=o}function e(o,r){this.typeNumber=o,this.errorCorrectLevel=r,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(){this.buffer=[],this.length=0}function i(){var o=0,r=0,e=0,n=new Array;return{get:function(){if(e>=o){var i=0;for(r=0;r<256;r++)i^=Math.random()*256|0;n=t.getBCHDigit(i)<<24|i,e=0,o=32}var a=1&n>>o;return o++,a}}}var t=function(){var o=function(o){var r=0;for(;0!=o;)r++,o>>>=1;return r};return{stringToBytes:function(o){for(var r=[],e=0;e<o.length;e++){var n=o.charCodeAt(e);n<128?r.push(n):n<2048?(r.push(192|(n>>6&31)),r.push(128|(63&n))):n<55296||n>=57344?(r.push(224|(n>>12&15)),r.push(128|(n>>6&63)),r.push(128|(63&n))):(e++,n=65536+((1023&n)<<10|1023&o.charCodeAt(e)),r.push(240|(n>>18&7)),r.push(128|(n>>12&63)),r.push(128|(n>>6&63)),r.push(128|(63&n)))}return r},getBCHDigit:o,MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8,ErrorCorrectLevel:{L:1,M:0,Q:3,H:2}}}();r.prototype={getLength:function(){return t.stringToBytes(this.data).length},write:function(o){for(var r=t.stringToBytes(this.data),e=0;e<r.length;e++)o.put(r[e],8)}};o.QRCode=e}(window);
</script>

<!-- APP (LocalStorage) -->
<script>
/* ===== LocalStorage Self-check ===== */
function localStorageAvailable(){
  try{
    const x='__ls_test__'+Math.random();
    localStorage.setItem(x,x);
    const ok = localStorage.getItem(x)===x;
    localStorage.removeItem(x);
    return ok;
  }catch(e){ return false; }
}
const lsOK = localStorageAvailable();
const lsStatus = document.getElementById('lsStatus');
if(lsOK){ lsStatus.textContent='LocalStorage OK'; lsStatus.classList.add('ok'); }
else { lsStatus.textContent='LocalStorage TIDAK tersedia (aktifkan storage / jangan mode private ketat)'; lsStatus.classList.add('err'); }

/* ===== Helpers ===== */
const $ = (s,el=document)=>el.querySelector(s);
const C = $('#previewCanvas');
const CTX = C.getContext('2d',{willReadFrequently:true});
const fmtDate = d => d.toLocaleString('id-ID',{dateStyle:'medium',timeStyle:'short'});
const rand = (n=12)=>Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>(b%36).toString(36)).join('').toUpperCase();
function makeResi(prefix){ const p=(prefix||'JNE').replace(/[^A-Z]/gi,'').slice(0,3).toUpperCase(); return p+'-'+rand(4)+'-'+rand(6); }
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
CanvasRenderingContext2D.prototype.rrect=function(x,y,w,h,r=10){this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();}
function wrapText(ctx, text, x, y, maxW, lh){ if(!text)return y; const words=String(text).split(/\s+/); let line=''; for(const w of words){const t=line?line+' '+w:w;if(ctx.measureText(t).width>maxW){ctx.fillText(line,x,y);y+=lh;line=w;}else line=t;} if(line){ctx.fillText(line,x,y);y+=lh;} return y; }
function drawBarcode(ctx, code, x, y, width, height){ const seed=[...code].reduce((a,c)=>a+c.charCodeAt(0),0); const rnd=mulberry32(seed); let curX=x; while(curX<x+width){ const w=Math.min(1+Math.floor(rnd()*4),x+width-curX); const h=height-(4+Math.floor(rnd()*12)); ctx.fillRect(curX,y+(height-h),w,h); curX+=w+(1+Math.floor(rnd()*2)); } }
function drawQR(ctx, text, x, y, size){
  const tmp = document.createElement('div');
  new window.QRCode(tmp,{ text, width:size, height:size, correctLevel:QRCode.CorrectLevel.M });
  const cvs = tmp.querySelector('canvas');
  if (cvs) ctx.drawImage(cvs, x, y, size, size);
}

/* ===== Logo input ===== */
let brandLogoImg=null;
$('#brandLogo')?.addEventListener('change',(e)=>{const f=e.target.files?.[0]; if(!f){brandLogoImg=null; return;} const img=new Image(); img.onload=()=>{brandLogoImg=img; render();}; img.src=URL.createObjectURL(f);});

/* ===== Render ===== */
function render(){
  const brand = $('#brandName').value.trim() || 'ResiKu';
  const sName = $('#senderName').value.trim() || '‚Äî';
  const sPhone= $('#senderPhone').value.trim() || '‚Äî';
  const sAddr = $('#senderAddress').value.trim() || '‚Äî';
  const bName = $('#buyerName').value.trim() || '‚Äî';
  const bPhone= $('#buyerPhone').value.trim() || '‚Äî';
  const bAddr = $('#buyerAddress').value.trim() || '‚Äî';
  const courier = $('#courier').value;
  const service = $('#service').value;
  const items = Math.max(1,+($('#items').value||1));
  const weight= Math.max(1,+($('#weight').value||1));
  const note = $('#note').value.trim() || '-';
  let resi = $('#resi').value.trim(); if(!resi){ resi=makeResi(courier); $('#resi').value=resi; }
  const codeRaw = resi.replaceAll('-','');

  // canvas bg
  CTX.clearRect(0,0,C.width,C.height);
  CTX.fillStyle='#fff'; CTX.fillRect(0,0,C.width,C.height);
  // border
  CTX.strokeStyle='#ddd'; CTX.lineWidth=2; CTX.rrect(20,20,960,1460,24); CTX.stroke();

  // header
  const pad=40, logoSize=60;
  if(brandLogoImg){ CTX.save(); CTX.beginPath(); CTX.rrect(pad,pad,logoSize,logoSize,10); CTX.clip(); CTX.drawImage(brandLogoImg,pad,pad,logoSize,logoSize); CTX.restore(); }
  else { const g=CTX.createLinearGradient(pad,pad,pad+logoSize,pad+logoSize); g.addColorStop(0,'#7C5CFF'); g.addColorStop(1,'#00E0A4'); CTX.fillStyle=g; CTX.rrect(pad,pad,logoSize,logoSize,10); CTX.fill(); }
  let f=32; CTX.fillStyle='#000'; CTX.font=`700 ${f}px Inter, Arial`; while(CTX.measureText(brand).width>500 && f>18){ f--; CTX.font=`700 ${f}px Inter, Arial`; }
  const textX=pad+logoSize+15; CTX.fillText(brand, textX, pad+35);
  CTX.font='400 20px Inter, Arial'; CTX.fillStyle='#444'; CTX.fillText('label pengiriman', textX, pad+65);

  CTX.textAlign='right'; CTX.fillStyle='#000'; CTX.font='800 36px Inter, Arial'; CTX.fillText(courier, 900, pad+42);
  CTX.font='700 18px Inter, Arial'; CTX.strokeStyle='#bbb'; CTX.rrect(900-60,pad+50,60,28,8); CTX.stroke();
  CTX.textAlign='center'; CTX.fillStyle='#000'; CTX.fillText(service, 900-30, pad+70);
  CTX.textAlign='left';

  // receiver & sender
  const boxY=130, boxH=280, gutter=20, colW=(960-pad*2-gutter)/2;
  CTX.rrect(pad,boxY,colW,boxH,14); CTX.stroke();
  CTX.font='700 22px Inter, Arial'; CTX.fillStyle='#000'; CTX.fillText('Penerima', pad+16, boxY+34);
  CTX.font='600 24px Inter, Arial'; CTX.fillText(bName, pad+16, boxY+70);
  CTX.font='400 18px Inter, Arial'; CTX.fillStyle='#333'; CTX.fillText(bPhone, pad+16, boxY+100);
  CTX.fillStyle='#111'; CTX.font='400 18px Inter, Arial'; wrapText(CTX, bAddr, pad+16, boxY+130, colW-32, 24);

  const x2=pad+colW+gutter;
  CTX.fillStyle='#000'; CTX.rrect(x2,boxY,colW,boxH,14); CTX.stroke();
  CTX.font='700 22px Inter, Arial'; CTX.fillText('Pengirim', x2+16, boxY+34);
  CTX.font='600 24px Inter, Arial'; CTX.fillText(sName, x2+16, boxY+70);
  CTX.font='400 18px Inter, Arial'; CTX.fillStyle='#333'; CTX.fillText(sPhone, x2+16, boxY+100);
  CTX.fillStyle='#111'; CTX.font='400 18px Inter, Arial'; wrapText(CTX, sAddr, x2+16, boxY+130, colW-32, 24);

  // resi + meta
  const midY=boxY+boxH+20, leftW=colW, rightW=colW;
  CTX.fillStyle='#000'; CTX.rrect(pad,midY,leftW,150,14); CTX.stroke();
  CTX.font='700 18px Inter, Arial'; CTX.fillText('No. Resi', pad+16, midY+32);
  CTX.font='800 28px "Courier New", ui-monospace, monospace';
  let rf=28; while(CTX.measureText(resi).width > leftW-32 && rf>20){ rf--; CTX.font=`800 ${rf}px "Courier New", ui-monospace, monospace`; } CTX.fillText(resi, pad+16, midY+76);

  const metaX=pad+leftW+gutter; CTX.rrect(metaX,midY,rightW,150,14); CTX.stroke();
  const now=fmtDate(new Date()); CTX.font='700 18px Inter, Arial'; CTX.fillText('Tanggal', metaX+16, midY+32);
  CTX.textAlign='right'; CTX.font='600 18px Inter, Arial'; CTX.fillText(now, metaX+rightW-16, midY+32);
  CTX.textAlign='left';  CTX.font='700 18px Inter, Arial'; CTX.fillText('Item', metaX+16, midY+70);
  CTX.textAlign='right'; CTX.font='600 18px Inter, Arial'; CTX.fillText(items+' pcs', metaX+rightW-16, midY+70);
  CTX.textAlign='left';  CTX.font='700 18px Inter, Arial'; CTX.fillText('Berat', metaX+16, midY+108);
  CTX.textAlign='right'; CTX.font='600 18px Inter, Arial'; CTX.fillText(weight+' g', metaX+rightW-16, midY+108);
  CTX.textAlign='left';  CTX.font='700 18px Inter, Arial'; CTX.fillText('Catatan', metaX+16, midY+146);
  CTX.textAlign='right'; CTX.font='600 18px Inter, Arial'; const noteTrim = note.length>40 ? note.slice(0,37)+'‚Ä¶' : note; CTX.fillText(noteTrim, metaX+rightW-16, midY+146);
  CTX.textAlign='left';

  // divider + barcode
  CTX.strokeStyle='#d6d6d6'; CTX.setLineDash([6,6]); CTX.beginPath(); CTX.moveTo(pad, midY+170); CTX.lineTo(960-pad, midY+170); CTX.stroke(); CTX.setLineDash([]);
  const bcY=midY+190; CTX.fillStyle='#000';
  drawBarcode(CTX, codeRaw, pad, bcY, 960-2*pad, 120);
  CTX.font='700 20px "Courier New", ui-monospace, monospace'; CTX.textAlign='center'; CTX.fillText(codeRaw, 500, bcY+140); CTX.textAlign='left';

  // QR RESI (isi QR = teks nomor resi)
  const size=180, x=960-40-size, y=1460-size-24;
  drawQR(CTX, resi, x, y, size);

  return { pngURL: C.toDataURL('image/png'), resi, courier, service, brand, items, weight, note, date: now };
}

/* ===== Cetak via hidden iframe ===== */
function printPNG(pngURL){
  const paper = $('#paper').value;
  const css = (paper==='a6') ? '@page{size:A6;margin:0}img{width:105mm;height:148mm}' : '@page{size:100mm 150mm;margin:0}img{width:100mm;height:150mm}';
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
  document.body.appendChild(iframe);
  iframe.onload = () => {
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(`<html><head><meta charset="utf-8"><style>html,body{margin:0}${css}</style></head><body><img src="${pngURL}" onload="setTimeout(()=>window.print(),50)"></body></html>`);
    doc.close();
    setTimeout(()=>document.body.removeChild(iframe), 5000);
  };
  iframe.src = 'about:blank';
}

/* ===== Download via Blob (kompatibel) ===== */
function downloadPNGFile(pngURL, filename){
  fetch(pngURL).then(res=>res.blob()).then(blob=>{
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }).catch(()=>{ const a=document.createElement('a'); a.href=pngURL; a.download=filename; a.click(); });
}

/* ===== LocalStorage ===== */
const LS_KEY = 'labels';
function getAll(){ if(!lsOK) return []; try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
function setAll(arr){ if(!lsOK) return; localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function saveToLocal(){
  const rec = render();
  if(!lsOK){ alert('LocalStorage tidak tersedia di browser ini. Aktifkan penyimpanan atau nonaktifkan mode private ketat.'); return; }
  const arr = getAll();
  const i = arr.findIndex(x=>x.resi===rec.resi);
  if(i>=0) arr[i] = {...arr[i], ...rec};
  else arr.unshift(rec);
  setAll(arr);
  alert('‚úÖ Tersimpan di localStorage.');
}

/* ===== History ===== */
function rowHTML(d){
  return `<tr>
    <td>${d.date||'-'}</td>
    <td><span class="badge">${d.resi||'-'}</span></td>
    <td>${d.brand||'-'}</td>
    <td>${d.courier||'-'}</td>
    <td>${d.service||'-'}</td>
    <td>
      <a href="${d.pngURL||'#'}" target="_blank" ${d.pngURL?'':'onclick="return false"'}>Buka</a>
      ¬∑ <a href="${d.pngURL||'#'}" ${d.pngURL?`download="label-${d.resi||'resi'}.png"`:'onclick="return false"'}>Unduh</a>
      ¬∑ <a href="#" data-print="${d.pngURL||''}">Cetak</a>
    </td>
  </tr>`;
}
function loadHistory(reset=false){
  const tbody = document.querySelector('#histTable tbody');
  if(!tbody) return;
  if(reset) tbody.innerHTML='';
  const arr = getAll();
  arr.forEach(d=>{ tbody.insertAdjacentHTML('beforeend', rowHTML(d)); });
}

/* ===== Search di history ===== */
document.getElementById('histSearch')?.addEventListener('input', ()=>{
  const q = document.getElementById('histSearch').value.trim().toLowerCase();
  document.querySelectorAll('#histTable tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});

/* ===== Events ===== */
const $on = (id,ev,fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener(ev, fn); };

$on('previewBtn','click',(e)=>{ e.preventDefault(); render(); });
$on('quickResiBtn','click',(e)=>{ e.preventDefault(); document.getElementById('resi').value=makeResi(document.getElementById('courier').value); render(); });

$on('printBtn','click',()=>{ const { pngURL } = render(); printPNG(pngURL); });
$on('printBtn2','click',()=>{ const { pngURL } = render(); printPNG(pngURL); });
$on('dlPngBtn','click',()=>{ const { pngURL, resi } = render(); downloadPNGFile(pngURL, `label-${resi}.png`); });
$on('dlPngBtn2','click',()=>{ const { pngURL, resi } = render(); downloadPNGFile(pngURL, `label-${resi}.png`); });
$on('saveLocalBtn','click',saveToLocal);
$on('saveLocalBtn2','click',saveToLocal);
$on('resetBtn','click',()=>{ if(!lsOK){ alert('LocalStorage tidak tersedia.'); return; } if(confirm('Hapus seluruh riwayat?')){ localStorage.removeItem(LS_KEY); loadHistory(true); alert('Riwayat dihapus.'); } });

document.getElementById('previewCanvas')?.addEventListener('click', ()=>{ const { pngURL } = render(); printPNG(pngURL); });

$on('tabMake','click',()=>{ document.getElementById('pageMake').classList.remove('hidden'); document.getElementById('pageHistory').classList.add('hidden'); document.getElementById('tabMake').classList.add('active'); document.getElementById('tabHistory').classList.remove('active'); });
$on('tabHistory','click',()=>{ document.getElementById('pageMake').classList.add('hidden'); document.getElementById('pageHistory').classList.remove('hidden'); document.getElementById('tabMake').classList.remove('active'); document.getElementById('tabHistory').classList.add('active'); loadHistory(true); });

$on('histRefresh','click',()=>loadHistory(true));
$on('exportJson','click', ()=>{
  if(!lsOK){ alert('LocalStorage tidak tersedia.'); return; }
  const data = getAll();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='labels.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
document.getElementById('importJson')?.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const txt = await file.text();
  try{
    const incoming = JSON.parse(txt);
    if(!Array.isArray(incoming)) throw new Error('Format JSON tidak sesuai (harus array).');
    const map = new Map(getAll().map(x=>[x.resi,x]));
    incoming.forEach(x=>{ if(x?.resi) map.set(x.resi, {...map.get(x.resi), ...x}); });
    const merged = Array.from(map.values()).sort((a,b)=>new Date(b.date)-new Date(a.date));
    setAll(merged);
    alert('‚úÖ Import berhasil.');
    loadHistory(true);
  }catch(err){ alert('Gagal import: '+err.message); }
});

/* Cetak dari tabel riwayat */
document.getElementById('histTable')?.addEventListener('click',(e)=>{
  const a = e.target.closest('a[data-print]'); if(!a) return;
  e.preventDefault();
  const url = a.getAttribute('data-print');
  if(!url) return alert('Belum ada gambar.');
  printPNG(url);
});

/* init awal */
render();
// buka langsung tab history jika pakai #history
if(location.hash==='#history'){ document.getElementById('tabHistory').click(); }
</script>
</body>
</html>
